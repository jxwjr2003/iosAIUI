# 端口冲突解决方案设计

## 问题分析

当前系统存在端口冲突问题：**端口 9700 被多个配置使用: workspace, 楼栋信息接口, 单元信息, 项目列表, 全部应用**

### 当前架构问题

1. **每个Mock服务器实例绑定到特定端口**
2. **端口冲突检测机制阻止相同端口的服务器启动**
3. **单个服务器实例只支持一个路由配置**
4. **缺乏基于路径的路由分发机制**

### 根本原因

在 [`MockServerManager.ts`](src/mock-server/mock-server-manager.ts:201-222) 中的 `detectPortConflicts` 方法检测到相同端口就报错，阻止启动。

## 解决方案：基于路径路由的多服务器共享端口

### 架构设计

```mermaid
graph TB
    A[客户端请求] --> B[共享端口服务器]
    B --> C{路径路由分发}
    C --> D[/api/workspace]
    C --> E[/api/building]
    C --> F[/api/unit]
    C --> G[/api/project]
    C --> H[/api/apps]
    D --> I[Workspace处理器]
    E --> J[楼栋信息处理器]
    F --> K[单元信息处理器]
    G --> L[项目列表处理器]
    H --> M[全部应用处理器]
```

### 核心修改点

#### 1. 修改类型定义
- 扩展 `MockServerConfig` 支持多路由
- 更新 `RouteConfig` 添加路径匹配规则

#### 2. 重构 MockServerEngine
- 支持多路由配置和路径匹配
- 实现请求路由分发逻辑

#### 3. 修改 MockServerManager
- 移除端口冲突检测
- 实现端口共享机制
- 支持相同端口的多个配置合并

#### 4. 更新配置管理器
- 支持多路由配置的保存和加载
- 向后兼容现有单路由配置

### 实施计划

#### 阶段1：类型定义和接口改造
- 修改 [`server-types.ts`](src/types/server-types.ts) 支持多路由
- 更新 [`mock-server-engine.ts`](src/mock-server/mock-server-engine.ts) 中的接口定义

#### 阶段2：核心引擎重构
- 重构 [`MockServerEngine`](src/mock-server/mock-server-engine.ts:50) 支持多路由
- 实现基于路径的路由匹配算法

#### 阶段3：管理器层改造
- 修改 [`MockServerManager`](src/mock-server/mock-server-manager.ts:10) 支持端口共享
- 移除端口冲突检测，改为配置合并

#### 阶段4：配置层适配
- 更新 [`ConfigManager`](src/config/config-manager.ts:17) 支持多路由配置
- 实现配置迁移和兼容性处理

#### 阶段5：实例层集成
- 修改 [`MockServerInstance`](src/mock-server/mock-server-instance.ts:7) 支持多路由
- 确保事件处理和状态管理正常

### 技术细节

#### 路由匹配策略
```typescript
interface EnhancedRouteConfig extends RouteConfig {
  pathPattern: string; // 支持通配符和参数
  priority: number;    // 匹配优先级
  isDefault?: boolean; // 默认路由
}
```

#### 端口共享机制
- 相同端口的配置自动合并到同一个服务器实例
- 基于请求路径和方法进行路由分发
- 支持路径参数和通配符匹配

#### 向后兼容性
- 现有单路由配置自动转换为多路由格式
- 保持API接口不变
- 确保现有功能不受影响

### 预期效果

1. **解决端口冲突**：多个配置可以共享同一端口
2. **提高资源利用率**：减少服务器实例数量
3. **增强灵活性**：支持更复杂的路由配置
4. **保持兼容性**：现有配置无需修改即可工作

### 风险评估

- **低风险**：核心逻辑封装在引擎内部，对外接口基本不变
- **可回滚**：修改模块化，出现问题可快速回退
- **渐进式**：可以分阶段实施和测试